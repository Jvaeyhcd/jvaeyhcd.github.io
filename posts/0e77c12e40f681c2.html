


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>【iOS】Runtime应用 [ Jvaeyhcd&#39;s Note ]</title>
  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  
    <!-- stylesheets list from _config.yml -->
    
      <link rel="stylesheet" href="/css/dexo.css">
    
      <link rel="stylesheet" href="/css/custom.css">
    
      <link rel="stylesheet" href="/css/post.css">
    
      <link rel="stylesheet" href="/css/page.css">
    
      <link rel="stylesheet" href="/css/layout.css">
    
      <link rel="stylesheet" href="/css/font-awesome.min.css">
    
  
<meta name="generator" content="Hexo 5.4.2"></head>
<body>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<div class="layout-container">
  <div class="layout-header">
    

<div class="main-nav">
  
  <div class="container">
    <header class="group top-nav">
      <nav class="navbar logo-w navbar-left">
        <a href="/" class="logo">Jvaeyhcd's Note</a>
      </nav>
      <div class="navigation-toggle" onClick="hideShowMenu()">
        <span class="logo">Jvaeyhcd's Note</span>
      </div>
      <nav id="navbar-menu" class="navbar item-nav navbar-right">
        <ul>
          
            <li><a href="/">Home</a></li>
          
            <li><a href="/archives">Archives</a></li>
          
            <li><a href="/tag">Tags</a></li>
          
            <li><a target="_blank" rel="noopener" href="https://github.com/Jvaeyhcd">Github</a></li>
          
        </ul>
      </nav>
    </header>
  </div>
</div>
  </div>
  <div class="layout-content">
    <div id="content-outer" class="container container-box">
      <div id="content-inner" class="content-view">
        <div class="post-content-box">
  <article id="post" class="post-detail-box box-section shadow">
    <div class="post-title">
      【iOS】Runtime应用
    </div>
    <div class="post-base-box">
      <time datetime="2018-08-08T08:47:52.000Z">
        Posted on 2018-08-08
      </time>
      
        <div class="category-item">
          In
          <a class="category-link-grey-link" href="/categories/iOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">iOS学习笔记</a>
        </div>
      
      <span id="busuanzi_container_page_pv">
        &nbsp;visitors <span id="busuanzi_value_page_pv"></span>
      </span>
    </div>
    <div class="post-body">
      <p><code>Runtime</code>简直就是做大型架构的利器，它的应用场景非常多，下面就介绍一些常见的应用场景。</p>
<ul>
<li>关联对象（Objective-C Associated Objects）给分类添加属性</li>
<li>方法魔法（Method Swizzling）方法添加、替换和KVO实现</li>
<li>消息转发（热更新）解决Bug（JSPatch）</li>
<li>实现NSCoding的自动归档和自动解档</li>
<li>实现字典和模型的自由转换（MJExtension）</li>
</ul>
<h2 id="关联对象（Objective-C-Associated-Objects）给分类添加属性"><a href="#关联对象（Objective-C-Associated-Objects）给分类添加属性" class="headerlink" title="关联对象（Objective-C Associated Objects）给分类添加属性"></a>关联对象（Objective-C Associated Objects）给分类添加属性</h2><p>通过对<code>objc_category</code>的结构体分析后我们知道分类是不能直接自定义属性和变量的，但是可以通过关联对象的方法给分类添加属性。</p>
<span id="more"></span>

<p>关联对象在<code>objc/runtime.h</code>中提供了以下几个接口：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Sets an associated value for a given object using a given key and association policy.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param object The source object for the association.</span></span><br><span class="line"><span class="comment"> * @param key The key for the association.</span></span><br><span class="line"><span class="comment"> * @param value The value to associate with the key key for object. Pass nil to clear an existing association.</span></span><br><span class="line"><span class="comment"> * @param policy The policy for the association. For possible values, see “Associative Object Behaviors.”</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @see objc_setAssociatedObject</span></span><br><span class="line"><span class="comment"> * @see objc_removeAssociatedObjects</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">// 关联对象</span></span><br><span class="line">OBJC_EXPORT <span class="type">void</span></span><br><span class="line">objc_setAssociatedObject(<span class="type">id</span> _Nonnull object, <span class="keyword">const</span> <span class="type">void</span> * _Nonnull key,</span><br><span class="line">                         <span class="type">id</span> _Nullable value, objc_AssociationPolicy policy)</span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.6</span>, <span class="number">3.1</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Returns the value associated with a given object for a given key.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param object The source object for the association.</span></span><br><span class="line"><span class="comment"> * @param key The key for the association.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @return The value associated with the key \e key for \e object.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @see objc_setAssociatedObject</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">// 获取关联的对象</span></span><br><span class="line">OBJC_EXPORT <span class="type">id</span> _Nullable</span><br><span class="line">objc_getAssociatedObject(<span class="type">id</span> _Nonnull object, <span class="keyword">const</span> <span class="type">void</span> * _Nonnull key)</span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.6</span>, <span class="number">3.1</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Removes all associations for a given object.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param object An object that maintains associated objects.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @note The main purpose of this function is to make it easy to return an object </span></span><br><span class="line"><span class="comment"> *  to a &quot;pristine state”. You should not use this function for general removal of</span></span><br><span class="line"><span class="comment"> *  associations from objects, since it also removes associations that other clients</span></span><br><span class="line"><span class="comment"> *  may have added to the object. Typically you should use \c objc_setAssociatedObject </span></span><br><span class="line"><span class="comment"> *  with a nil value to clear an association.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @see objc_setAssociatedObject</span></span><br><span class="line"><span class="comment"> * @see objc_getAssociatedObject</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">// 移除关联的对象</span></span><br><span class="line">OBJC_EXPORT <span class="type">void</span></span><br><span class="line">objc_removeAssociatedObjects(<span class="type">id</span> _Nonnull object)</span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.6</span>, <span class="number">3.1</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br></pre></td></tr></table></figure>

<p>参数解释：</p>
<ul>
<li>id object：被关联的对象</li>
<li>const void *key：被关联的key，要求唯一</li>
<li>id value：关联的对象</li>
<li>objc_AssociationPolicy policy：内存管理的策略</li>
</ul>
<p>内存管理策略的定义有：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Policies related to associative references.</span></span><br><span class="line"><span class="comment"> * These are options to objc_setAssociatedObject()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> OBJC_ENUM(uintptr_t, objc_AssociationPolicy) &#123;</span><br><span class="line">    OBJC_ASSOCIATION_ASSIGN = <span class="number">0</span>,           <span class="comment">/**&lt; Specifies a weak reference to the associated object. */</span></span><br><span class="line">    OBJC_ASSOCIATION_RETAIN_NONATOMIC = <span class="number">1</span>, <span class="comment">/**&lt; Specifies a strong reference to the associated object. </span></span><br><span class="line"><span class="comment">                                            *   The association is not made atomically. */</span></span><br><span class="line">    OBJC_ASSOCIATION_COPY_NONATOMIC = <span class="number">3</span>,   <span class="comment">/**&lt; Specifies that the associated object is copied. </span></span><br><span class="line"><span class="comment">                                            *   The association is not made atomically. */</span></span><br><span class="line">    OBJC_ASSOCIATION_RETAIN = <span class="number">01401</span>,       <span class="comment">/**&lt; Specifies a strong reference to the associated object.</span></span><br><span class="line"><span class="comment">                                            *   The association is made atomically. */</span></span><br><span class="line">    OBJC_ASSOCIATION_COPY = <span class="number">01403</span>          <span class="comment">/**&lt; Specifies that the associated object is copied.</span></span><br><span class="line"><span class="comment">                                            *   The association is made atomically. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>下面实例实现了给<code>UIView</code>的<code>Category</code>添加自定义属性<code>defaultColor</code>。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="string">&quot;objc/runtime.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UIView</span> (<span class="title">DefaultColor</span>)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *defaultColor;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIView</span> (<span class="title">DefaultColor</span>)</span></span><br><span class="line"><span class="keyword">@dynamic</span> defaultColor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="type">char</span> kDefaultColor;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)setDefaultColor:(<span class="built_in">UIColor</span> *)defaultColor &#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, &amp;kDefaultColor, defaultColor, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UIColor</span> *)defaultColor &#123;</span><br><span class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, &amp;kDefaultColor);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> : <span class="title">UIViewController</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">    <span class="built_in">UIView</span> *view = [<span class="built_in">UIView</span> new];</span><br><span class="line">    view.defaultColor = [<span class="built_in">UIColor</span> blueColor];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, view.defaultColor);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>打印结果：</p>
<blockquote>
<p>2018-08-08 22:21:41.683715+0800 Runtime[59801:3820981] UIExtendedSRGBColorSpace 0 0 1 1</p>
</blockquote>
<p>从打印结果来看，我们成功在分类上添加了一个属性，实现了他的<code>getter</code>和<code>setter</code>方法。通过关联对象实现属性的内存管理也是有<code>ARC</code>管理的，所以我们只需要给定适当的内存策略就行了，不需要操心对象的释放。</p>
<p>内存策略对应的属性修饰符对比如下表：</p>
<table><tr><td>内存策略</td><td>属性修饰</td><td>描述</td></tr><tr><td>OBJC_ASSOCIATION_ASSIGN</td><td>@property (assign) 或 @property (unsafe_unretained)</td><td>指定一个关联对象的弱引用</td></tr><tr><td>OBJC_ASSOCIATION_RETAIN<br/>_NONATOMIC</td><td>@property (nonatomic, strong)</td><td>@property (nonatomic, strong)    指定一个关联对象的强引用，不能被原子化使用</td></tr><tr><td>OBJC_ASSOCIATION_COPY<br/>_NONATOMIC</td><td>@property (nonatomic, copy)</td><td>指定一个关联对象的copy引用，不能被原子化使用</td></tr><tr><td>OBJC_ASSOCIATION_RETAIN</td><td>@property (atomic, strong)</td><td>指定一个关联对象的强引用，能被原子化使用</td></tr><tr><td>OBJC_ASSOCIATION_COPY</td><td>@property (atomic, copy)</td><td>指定一个关联对象的copy引用，能被原子化使用</td></tr></table>

<h2 id="方法魔法（Method-Swizzling）方法添加、替换和KVO实现"><a href="#方法魔法（Method-Swizzling）方法添加、替换和KVO实现" class="headerlink" title="方法魔法（Method Swizzling）方法添加、替换和KVO实现"></a>方法魔法（Method Swizzling）方法添加、替换和KVO实现</h2><h3 id="方法添加"><a href="#方法添加" class="headerlink" title="方法添加"></a>方法添加</h3><p>在<a href="">Rutime详解</a>中介绍消息转发的时候，动态方法的添加就已经提到了。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Adds a new method to a class with a given name and implementation.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param cls The class to which to add a method.</span></span><br><span class="line"><span class="comment"> * @param name A selector that specifies the name of the method being added.</span></span><br><span class="line"><span class="comment"> * @param imp A function which is the implementation of the new method. The function must take at least two arguments—self and _cmd.</span></span><br><span class="line"><span class="comment"> * @param types An array of characters that describe the types of the arguments to the method. </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @return YES if the method was added successfully, otherwise NO </span></span><br><span class="line"><span class="comment"> *  (for example, the class already contains a method implementation with that name).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @note class_addMethod will add an override of a superclass&#x27;s implementation, </span></span><br><span class="line"><span class="comment"> *  but will not replace an existing implementation in this class. </span></span><br><span class="line"><span class="comment"> *  To change an existing implementation, use method_setImplementation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">OBJC_EXPORT <span class="type">BOOL</span></span><br><span class="line">class_addMethod(Class _Nullable cls, SEL _Nonnull name, IMP _Nonnull imp, </span><br><span class="line">                <span class="keyword">const</span> <span class="type">char</span> * _Nullable types) </span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.5</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>cls：被添加方法的类</li>
<li>name：添加的方法名称的SEL</li>
<li>imp：方法的实现。改函数至少要有两个参数，<code>self</code>和<code>_cmd</code></li>
<li>types：类型编码</li>
</ul>
<h3 id="方法替换"><a href="#方法替换" class="headerlink" title="方法替换"></a>方法替换</h3><p>下面实现了一个替换<code>UIViewController</code>的<code>viewDidLoad</code>方法的例子：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        Class <span class="keyword">class</span> = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line">        SEL originalSelector = <span class="keyword">@selector</span>(viewDidLoad);</span><br><span class="line">        SEL swizzledSelector = <span class="keyword">@selector</span>(swizzledViewDidLoad);</span><br><span class="line">        </span><br><span class="line">        Method originalMethod = class_getInstanceMethod(<span class="keyword">self</span>, originalSelector);</span><br><span class="line">        Method swizzledMethod = class_getInstanceMethod(<span class="keyword">self</span>, swizzledSelector);</span><br><span class="line">        </span><br><span class="line">        <span class="type">BOOL</span> didAddMethod = class_addMethod(<span class="keyword">class</span>, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod));</span><br><span class="line">        <span class="keyword">if</span> (didAddMethod) &#123;</span><br><span class="line">            class_replaceMethod(<span class="keyword">class</span>, swizzledMethod, method_getImplementation(originalMethod), method_getTypeEncoding(originalSelector));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            method_exchangeImplementations(originalMethod, swizzledMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)swizzledViewDidLoad &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;替换的方法&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> swizzledViewDidLoad];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)viewDidLoad &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;自带的方法&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    [<span class="variable language_">super</span> viewDidLoad];</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>打印结果：</p>
<blockquote>
<p>2018-08-08 23:30:51.912380+0800 Runtime[70331:3958814] 替换的方法<br>2018-08-08 23:30:51.913268+0800 Runtime[70331:3958814] 自带的方法</p>
</blockquote>
<p><code>method swizzling</code>在<code>+load</code>中完成，在<code>Objective-C</code>的运行时中，每个类有两个方法会自动调用。<code>+ (void)load</code>是在一个类被初始装载时调用的，<code>+ (void)initialize</code>是在应用第一次调用该类方法或实例方法前调用的。两个方法都是可选的，并且在方法被实现的情况下才会调用。</p>
<p><code>swizzling</code>只能在<code>dispatch_once</code>中完成，由于<code>swizzling</code>改变了全局的状态，所以我们需要确保每个预防措施在运行时都是可用的。原子操作就是这样用于确保代码只执行一次的预防措施，就算是在不同的线程中也能确保代码只执行一次。<code>gcd</code>的<code>dispatch_once</code>满足了所需要的需求。</p>
<h3 id="KVO实现"><a href="#KVO实现" class="headerlink" title="KVO实现"></a>KVO实现</h3><blockquote>
<p>KVO全称是key-value observing，翻译成中文就是键值观察。提供了一种当对象属性被修改的时候能通知当前对象的一种机制。在MVC设计架构下的项目，KVO机制很适合做Model与Controller之间的通讯。</p>
</blockquote>
<p>KVO的实现依赖于Objective-C强大的Runtime，Apple使用isa混写（isa-swizzling）来实现KVO。当观察对象A时，KVO机制动态创建一个新的名为<code>NSKVONotifying_A</code>的新类，该类继承自对象A的本类，且KVO为<code>NSKVONotifying_A</code>类重写观察属性的<code>setter</code>方法，<code>setter</code>方法会负责在调用原<code>setter</code>之前和之后，通知所观察对象属性值的更改情况。</p>
<ul>
<li>NSKVONotifying_A类剖析</li>
</ul>
<p>从应用层面看，完全没有意识到新的类的产生，这是系统“隐瞒”了对KVO底层的实现过程，让我们误以为还是原来的类。但是此时我们如果新建一个名为<code>NSKVONotifying_A</code>的类，就会发现系统运行到注册KVO那段代码的时候程序就奔溃了，因为在注册监听的时候动态创建了名为<code>NSKVONotifying_A</code>的中间类，并指向这个中间类。</p>
<ul>
<li>子类setter方法剖析</li>
</ul>
<p>KVO的键值观察依赖<code>NSObject</code>的两个方法：<code>willChangeValueForKey:</code>和<code>didChangeValueForKey:</code>，在存取的前后分别调用这2个方法。在被观察属性发生改变之前，<code>willChangeValueForKey:</code>被调用，通知系统该<code>keyPath</code>属性值即将变更；当被观察属性发生改变之后，<code>didChangeValueForKey:</code>被调用，通知系统该<code>keyPath</code>属性值已经变更；之后<code>observeValueForKey:ofObject:change:context: </code>也会被调用。且重写观察属性的 <code>setter</code> 方法这种继承方式的注入是在运行时而不是编译时实现的。</p>
<p>KVO子类setter方法的重写调用存取方法的工作原理在代码中相当于：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="type">void</span>)setName:(<span class="built_in">NSString</span> *)newName&#123; </span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@&quot;name&quot;</span>];    <span class="comment">//KVO 在调用存取方法之前总调用 </span></span><br><span class="line">    [<span class="variable language_">super</span> setValue:newName forKey:<span class="string">@&quot;name&quot;</span>]; <span class="comment">//调用父类的存取方法 </span></span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@&quot;name&quot;</span>];     <span class="comment">//KVO 在调用存取方法之后总调用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="消息转发（热更新）解决Bug（JSPatch）"><a href="#消息转发（热更新）解决Bug（JSPatch）" class="headerlink" title="消息转发（热更新）解决Bug（JSPatch）"></a>消息转发（热更新）解决Bug（JSPatch）</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/bang590/JSPatch/wiki/JSPatch-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3">JSPatch</a> 是一个 iOS 动态更新框架，只需在项目中引入极小的引擎，就可以使用 JavaScript 调用任何 Objective-C 原生接口，获得脚本语言的优势：为项目动态添加模块，或替换项目原生代码动态修复 bug。</p>
</blockquote>
<p>关于消息转发，我们知道分为三级，我们可以在每级实现替换功能，实现消息转发，从而不造成崩溃。JSPatch不仅能够实现消息转发，还可以实现方法的添加、替换等一系列功能。</p>
<h2 id="实现NSCoding的自动归档和自动解档"><a href="#实现NSCoding的自动归档和自动解档" class="headerlink" title="实现NSCoding的自动归档和自动解档"></a>实现NSCoding的自动归档和自动解档</h2><p>原理描述：用<code>Runtime</code>提供的函数遍历<code>Model</code>自身所有属性，并对属性进行<code>encode</code>和<code>decode</code>操作。核心方法是在<code>Model</code>基类中重写方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)coder</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> initWithCoder:coder];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> outCount;</span><br><span class="line">        Ivar * ivars = class_copyIvarList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) &#123;</span><br><span class="line">            Ivar ivar = ivars[i];</span><br><span class="line">            <span class="built_in">NSString</span> * key = [<span class="built_in">NSString</span> stringWithUTF8String:ivar_getName(ivar)];</span><br><span class="line">            [<span class="keyword">self</span> setValue:[coder decodeObjectForKey:key] forKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)coder</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="variable language_">super</span> encodeWithCoder:coder];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> outCount;</span><br><span class="line">    Ivar * ivars = class_copyIvarList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) &#123;</span><br><span class="line">        Ivar ivar = ivars[i];</span><br><span class="line">        <span class="built_in">NSString</span> * key = [<span class="built_in">NSString</span> stringWithUTF8String:ivar_getName(ivar)];</span><br><span class="line">        [coder encodeObject:[<span class="keyword">self</span> valueForKey:key] forKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现字典和模型的自由转换（MJExtension）"><a href="#实现字典和模型的自由转换（MJExtension）" class="headerlink" title="实现字典和模型的自由转换（MJExtension）"></a>实现字典和模型的自由转换（MJExtension）</h2><p>原理描述：用Runtime提供的函数遍历Model自身所有属性，如果属性在JSON中有对应的值，则将其赋值。核心方法在NSObject的分类中添加方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithDict:(<span class="built_in">NSDictionary</span> *)dict &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">self</span> init]) &#123;</span><br><span class="line">        <span class="comment">//(1)获取类的属性及属性对应的类型</span></span><br><span class="line">        <span class="built_in">NSMutableArray</span> * keys = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">        <span class="built_in">NSMutableArray</span> * attributes = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 例子</span></span><br><span class="line"><span class="comment">         * name = value3 attribute = T@&quot;NSString&quot;,C,N,V_value3</span></span><br><span class="line"><span class="comment">         * name = value4 attribute = T^i,N,V_value4</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> outCount;</span><br><span class="line">        objc_property_t * properties = class_copyPropertyList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) &#123;</span><br><span class="line">            objc_property_t property = properties[i];</span><br><span class="line">            <span class="comment">//通过property_getName函数获得属性的名字</span></span><br><span class="line">            <span class="built_in">NSString</span> * propertyName = [<span class="built_in">NSString</span> stringWithCString:property_getName(property) encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">            [keys addObject:propertyName];</span><br><span class="line">            <span class="comment">//通过property_getAttributes函数可以获得属性的名字和@encode编码</span></span><br><span class="line">            <span class="built_in">NSString</span> * propertyAttribute = [<span class="built_in">NSString</span> stringWithCString:property_getAttributes(property) encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">            [attributes addObject:propertyAttribute];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//立即释放properties指向的内存</span></span><br><span class="line">        free(properties);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//(2)根据类型给属性赋值</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSString</span> * key <span class="keyword">in</span> keys) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([dict valueForKey:key] == <span class="literal">nil</span>) <span class="keyword">continue</span>;</span><br><span class="line">            [<span class="keyword">self</span> setValue:[dict valueForKey:key] forKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
    </div>
  </article>

  <ul class="post-pager">
    
    <li class="previous">
      <a href="/posts/6c8932d6101bb275.html">← Previous Post</a>
    </li>
    
    
    <li class="next">
      <a href="/posts/187e06540a0329db.html">Next Post →</a>
    </li>
    
  </ul>

  <div class="box-section shadow box-comment">
    <!-- 
  <section class="disqus-comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>

  <script>
    var disqus_shortname = 'jvaeyhcd';
    
    var disqus_url = 'https://jvaeyhcd.github.io/posts/0e77c12e40f681c2.html';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>

  <script id="dsq-count-scr" src="//jvaeyhcd.disqus.com/count.js" async></script>


 -->
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<div id="gitalk-container"></div>
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '29d526fe1e0f29d6b28c',
        clientSecret: '1e5c674f3cbce0ba7d19045138d69ef800d5bd21',
        id: window.location.pathname,
        repo: 'jvaeyhcd.github.io',
        owner: 'Jvaeyhcd',
        admin: 'Jvaeyhcd'
    })
    gitalk.render('gitalk-container')
</script>
  </div>
</div>
      </div>
    </div>
  </div>
  <div class="layout-footer">
    <div id="bottom-outer" class="container">
  <div id="bottom-inner">
    <span>
    &copy; 2016-2022 Jvaeyhcd using
    <a style="color:#007fff;" target="_blank" rel="noopener" href="http://hexo.io">Hexo</a>.
    </span>
    
      <div class="busuanzi-box">
        <!-- 不蒜子统计 -->
        <span id="busuanzi_container_site_pv">
                本站总访问量<span id="busuanzi_value_site_pv"></span>次
        </span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv" style='display:none'>
                本站访客数<span id="busuanzi_value_site_uv"></span>人
        </span>
      </div>
    
    <a class="footer-icon" target="_blank" rel="noopener" href="https://github.com/Jvaeyhcd"><i class="fab fa-github"></i></a>
  </div>
</div>
<link href="https://unpkg.com/ionicons@4.5.10-0/dist/css/ionicons.min.css" rel="stylesheet">
<button id="totop" class="back-top">
  <i class="icon ion-md-arrow-dropup"></i>
</button>

<script src="//code.jquery.com/jquery-2.0.3.min.js"></script>
<script src="/js/back-top.js"></script>

  </div>
</div>



  <!-- scripts list from theme config.yml -->
  
    <script src="/js/dexo.js"></script>
  
    <script src="/js/helper.js"></script>
  


</body>
</html>
